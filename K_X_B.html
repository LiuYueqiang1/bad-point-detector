<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Y16ä¸Šä½æœº | å¤§ç«¯é»˜è®¤+ä¸‰æ–‡ä»¶è¿ç®— K*(X-B) + æ··åˆè°ƒå…‰ + ä¿å­˜RAW</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style type="text/tailwindcss">
        @layer utilities {
            .canvas-box { @apply relative border border-gray-300 rounded-lg overflow-hidden bg-gray-100; }
            .control-card { @apply bg-white p-4 rounded-lg shadow-md; }
            .btn { @apply px-4 py-2 rounded transition-all duration-200 flex items-center justify-center gap-2; }
            .btn-primary { @apply bg-blue-600 hover:bg-blue-700 text-white; }
            .btn-secondary { @apply bg-white border border-gray-300 hover:bg-gray-100; }
            .btn-success { @apply bg-green-600 hover:bg-green-700 text-white; }
            .btn-warning { @apply bg-orange-600 hover:bg-orange-700 text-white; }
            .status { @apply bg-gray-50 p-2 rounded text-sm border border-gray-200 mt-3; }
            .info-panel { @apply bg-gray-900 text-white p-3 rounded-lg text-sm font-mono max-h-40 overflow-auto mt-3; }
            .file-status { @apply text-xs mt-2 text-green-600 flex items-center gap-1 hidden; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i class="fa fa-calculator text-blue-600"></i> Y16 16bitç°åº¦ä¸Šä½æœºã€å¤§ç«¯é»˜è®¤+K*(X-B)è¿ç®—+ä¿å­˜RAWã€‘
        </h1>
        <p class="text-gray-500 mb-6">æ ¸å¿ƒè¿ç®—ï¼šY16=(K.*(X-B))/4096+8192 | æ··åˆè°ƒå…‰=0.3çº¿æ€§+0.7ç›´æ–¹å›¾ | ä¿å­˜è¿ç®—ç»“æœä¸ºRAWæ ¼å¼</p>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="lg:col-span-1 space-y-4">
                <div class="control-card">
                    <h2 class="text-lg font-semibold mb-3 pb-2 border-b border-gray-200">ä¸‰æ–‡ä»¶åŠ è½½ã€æ ¸å¿ƒã€‘</h2>
                    <!-- åŠ è½½Kæ–‡ä»¶ Uint16 -->
                    <label class="btn btn-primary w-full cursor-pointer mb-2">
                        <i class="fa fa-file-text-o"></i> åŠ è½½ K æ–‡ä»¶ (uint16-ç³»æ•°)
                        <input type="file" id="fileInputK" accept=".raw,.bin,.dat,.y16" class="hidden">
                    </label>
                    <div id="fileKStatus" class="file-status"><i class="fa fa-check"></i> Kæ–‡ä»¶åŠ è½½å®Œæˆ</div>
                    <!-- åŠ è½½X16æ–‡ä»¶ Uint16 -->
                    <label class="btn btn-primary w-full cursor-pointer mb-2">
                        <i class="fa fa-file-text-o"></i> åŠ è½½ X16 æ–‡ä»¶ (uint16-åŸå§‹å›¾åƒ)
                        <input type="file" id="fileInputX" accept=".raw,.bin,.dat,.y16" class="hidden">
                    </label>
                    <div id="fileXStatus" class="file-status"><i class="fa fa-check"></i> X16æ–‡ä»¶åŠ è½½å®Œæˆ</div>
                    <!-- åŠ è½½Bæ–‡ä»¶ Int16 -->
                    <label class="btn btn-primary w-full cursor-pointer mb-2">
                        <i class="fa fa-file-text-o"></i> åŠ è½½ B æ–‡ä»¶ (int16-åŸºå‡†å€¼)
                        <input type="file" id="fileInputB" accept=".raw,.bin,.dat,.y16" class="hidden">
                    </label>
                    <div id="fileBStatus" class="file-status"><i class="fa fa-check"></i> Bæ–‡ä»¶åŠ è½½å®Œæˆ</div>
                    
                    <div class="grid grid-cols-2 gap-2 mt-3">
                        <div><label class="text-xs">å®½åº¦</label><input type="number" id="w" value="640" class="w-full text-sm border rounded px-2 py-1 mt-1"></div>
                        <div><label class="text-xs">é«˜åº¦</label><input type="number" id="h" value="512" class="w-full text-sm border rounded px-2 py-1 mt-1"></div>
                    </div>
                    <button id="applySize" class="btn btn-secondary w-full mt-2 text-sm py-1">åº”ç”¨å°ºå¯¸</button>

                    <!-- å¤§å°ç«¯ã€é»˜è®¤å¤§ç«¯ å–æ¶ˆå‹¾é€‰ã€‘+è¡Œåˆ—ä¼˜å…ˆ -->
                    <div class="space-y-2 mt-3">
                        <div class="flex items-center gap-2 p-2 bg-gray-50 rounded border border-gray-200">
                            <input type="checkbox" id="littleEndian">
                            <label for="littleEndian" class="text-sm">å°ç«¯åºå­˜å‚¨ (å–æ¶ˆ=å¤§ç«¯ï¼Œé»˜è®¤)</label>
                        </div>
                        <div class="flex items-center gap-2 p-2 bg-gray-50 rounded border border-gray-200">
                            <input type="checkbox" id="rowMajor" checked>
                            <label for="rowMajor" class="text-sm">è¡Œä¼˜å…ˆå­˜å‚¨</label>
                        </div>
                    </div>

                    <!-- æ ¸å¿ƒè¿ç®—æŒ‰é’® + æ–°å¢ä¿å­˜æŒ‰é’® -->
                    <button id="calcBtn" class="btn btn-success w-full mt-4">
                        <i class="fa fa-refresh"></i> æ‰§è¡Œè¿ç®— Y16=K*(X-B)
                    </button>
                    <button id="saveBtn" class="btn btn-warning w-full mt-2">
                        <i class="fa fa-save"></i> ä¿å­˜Y16ç»“æœä¸º RAW æ ¼å¼
                    </button>
                </div>

                <div class="control-card">
                    <h2 class="text-lg font-semibold mb-3 pb-2 border-b border-gray-200">æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢</h2>
                    <div class="space-y-2">
                        <button id="btnOrigin" class="btn btn-secondary w-full">
                            <i class="fa fa-eye"></i> åŸå§‹è¿ç®—ç»“æœæ˜¾ç¤º
                        </button>
                        <button id="btnMixLight" class="btn btn-primary w-full">
                            <i class="fa fa-adjust"></i> æ··åˆè°ƒå…‰æ˜¾ç¤º(æ¨è)
                        </button>
                    </div>
                    <div class="status">
                        âœ… å½“å‰æ¨¡å¼ï¼š<span id="curMode" class="font-medium text-blue-600">æ··åˆè°ƒå…‰</span>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§å›¾åƒæ˜¾ç¤ºåŒº -->
            <div class="lg:col-span-3 space-y-3">
                <div class="canvas-box" style="height: 600px;">
                    <canvas id="mainCanvas" class="w-full h-full"></canvas>
                    <div id="loading" class="absolute inset-0 bg-black/50 flex items-center justify-center hidden">
                        <div class="bg-white p-4 rounded-lg flex items-center gap-2"><i class="fa fa-spinner fa-spin text-blue-600"></i>æ–‡ä»¶è§£æ/è¿ç®—ä¸­...</div>
                    </div>
                    <div id="noImg" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                        <i class="fa fa-picture-o text-5xl mb-2"></i>
                        <p>è¯·ä¾æ¬¡åŠ è½½ Kã€X16ã€B æ–‡ä»¶åæ‰§è¡Œè¿ç®—</p>
                    </div>
                </div>

                <div class="status">
                    åƒç´ ä¿¡æ¯ï¼šX=<span id="px">--</span> | Y=<span id="py">--</span> | è¿ç®—åç°åº¦å€¼=<span id="pv" class="font-medium text-red-600">--</span> (0~65535)
                </div>

                <div class="info-panel" id="imgInfo">
                    <p>ğŸ“Š ç­‰å¾…åŠ è½½æ–‡ä»¶å¹¶æ‰§è¡Œè¿ç®—</p>
                    <p>âœ¨ è¿ç®—å…¬å¼ï¼šY16 = (K .* (X - B)) / 4096 + 8192</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== å…¨å±€æ ¸å¿ƒå˜é‡ =====
        let KData = null;         // Kæ–‡ä»¶æ•°æ® - Uint16 æ— ç¬¦å·16ä½ (ç³»æ•°)
        let XData = null;         // X16æ–‡ä»¶æ•°æ® - Uint16 æ— ç¬¦å·16ä½ (åŸå§‹å›¾åƒ)
        let BData = null;         // Bæ–‡ä»¶æ•°æ® - Int16 æœ‰ç¬¦å·16ä½ (åŸºå‡†å€¼)
        let calcResultData = null;// è¿ç®—åæœ€ç»ˆY16æ•°æ® Uint16 [0~65535]
        let fileBufferK = null;
        let fileBufferX = null;
        let fileBufferB = null;
        let W = 640, H = 512;     // å›¾åƒå®½é«˜
        let rowMajor = true;      // è¡Œä¼˜å…ˆ/åˆ—ä¼˜å…ˆ
        let littleEndian = false; // âœ… é»˜è®¤å¤§ç«¯åº falseï¼Œå°ç«¯=true
        let curDispMode = "mix";  // origin=åŸå§‹è¿ç®—ç»“æœ mix=æ··åˆè°ƒå…‰
        let canvasImgData = null; // ç”»å¸ƒå›¾åƒæ•°æ®

        // ç”»å¸ƒäº¤äº’å˜é‡
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let scale = 1, ox = 0, oy = 0;
        let isDrag = false, lx, ly;

        // DOMå…ƒç´ 
        const fileInputK = document.getElementById('fileInputK');
        const fileInputX = document.getElementById('fileInputX');
        const fileInputB = document.getElementById('fileInputB');
        const fileKStatus = document.getElementById('fileKStatus');
        const fileXStatus = document.getElementById('fileXStatus');
        const fileBStatus = document.getElementById('fileBStatus');
        const wInput = document.getElementById('w');
        const hInput = document.getElementById('h');
        const applySize = document.getElementById('applySize');
        const rowMajorCb = document.getElementById('rowMajor');
        const littleEndianCb = document.getElementById('littleEndian');
        const calcBtn = document.getElementById('calcBtn');
        const saveBtn = document.getElementById('saveBtn'); // æ–°å¢ä¿å­˜æŒ‰é’®DOM
        const loading = document.getElementById('loading');
        const noImg = document.getElementById('noImg');
        const btnOrigin = document.getElementById('btnOrigin');
        const btnMixLight = document.getElementById('btnMixLight');
        const curMode = document.getElementById('curMode');
        const px = document.getElementById('px');
        const py = document.getElementById('py');
        const pv = document.getElementById('pv');
        const imgInfo = document.getElementById('imgInfo');

        // ===== âœ…ã€ä¿®å¤BUGï¼šåˆå§‹åŒ–å¼ºåˆ¶éšè—æ‰€æœ‰æ–‡ä»¶åŠ è½½çŠ¶æ€ã€‘=====
        fileKStatus.classList.add('hidden');
        fileXStatus.classList.add('hidden');
        fileBStatus.classList.add('hidden');

        // ===== âœ…ã€æ ¸å¿ƒ1ï¼šæ²¿ç”¨éªŒè¯æ— è¯¯çš„ å¤§å°ç«¯è§£æé€»è¾‘ æ”¯æŒUint16/Int16ã€‘=====
        // è§£ææ— ç¬¦å·16ä½ (K/Xæ–‡ä»¶)
        function parseUint16Data(buffer) {
            if(!buffer) return null;
            const pixelCount = W * H;
            const needBytes = pixelCount * 2;
            if(buffer.byteLength < needBytes) return null;
            const u8Arr = new Uint8Array(buffer, 0, needBytes);
            const data = new Uint16Array(pixelCount);
            if(littleEndian){
                for(let i=0; i<pixelCount; i++) data[i] = u8Arr[i*2] | (u8Arr[i*2+1] << 8);
            }else{
                for(let i=0; i<pixelCount; i++) data[i] = (u8Arr[i*2] << 8) | u8Arr[i*2+1];
            }
            return data;
        }
        // è§£ææœ‰ç¬¦å·16ä½ (Bæ–‡ä»¶ é‡ä¸­ä¹‹é‡ å’ŒMATLABä¸€è‡´)
        function parseInt16Data(buffer) {
            if(!buffer) return null;
            const pixelCount = W * H;
            const needBytes = pixelCount * 2;
            if(buffer.byteLength < needBytes) return null;
            const u8Arr = new Uint8Array(buffer, 0, needBytes);
            const data = new Int16Array(pixelCount);
            if(littleEndian){
                for(let i=0; i<pixelCount; i++) data[i] = u8Arr[i*2] | (u8Arr[i*2+1] << 8);
            }else{
                for(let i=0; i<pixelCount; i++) data[i] = (u8Arr[i*2] << 8) | u8Arr[i*2+1];
            }
            return data;
        }

        // ===== âœ…ã€æ ¸å¿ƒ2ï¼š1:1å¤åˆ»ä½ çš„MATLABæ··åˆè°ƒå…‰ç®—æ³• æ— ä»»ä½•æ”¹åŠ¨ã€‘=====
        function light_line(src_image) {
            const src_double = Float64Array.from(src_image);
            const minVal = getArrayMin(src_double);
            const maxVal = getArrayMax(src_double);
            const des = new Uint8Array(src_image.length);
            if (maxVal === minVal) {
                des.fill(0); // é™¤é›¶ä¿æŠ¤
            } else {
                for(let i=0; i<src_image.length; i++){
                    des[i] = Math.round( (src_double[i] - minVal) * 255 / (maxVal - minVal) );
                }
            }
            return des;
        }
        function light_hist(src_image) {
            const src_double = Float64Array.from(src_image);
            const totalPixels = src_image.length;
            const des = new Uint8Array(totalPixels);
            if(totalPixels === 0) return des;
            const minVal = getArrayMin(src_double);
            const maxVal = getArrayMax(src_double);
            const counts = new Array(maxVal - minVal + 1).fill(0);
            for(let val of src_double) counts[val - minVal]++;
            const cumulativeHistogram = new Array(counts.length);
            cumulativeHistogram[0] = counts[0];
            for(let i=1; i<counts.length; i++) cumulativeHistogram[i] = cumulativeHistogram[i-1] + counts[i];
            for(let i=0; i<src_image.length; i++){
                let idx = src_double[i] - minVal;
                idx = Math.max(0, Math.min(idx, cumulativeHistogram.length - 1));
                des[i] = Math.round( cumulativeHistogram[idx] * 255 / totalPixels );
            }
            return des;
        }
        function light_mix(src_image) {
            const line = light_line(src_image);
            const hist = light_hist(src_image);
            const des = new Uint8Array(src_image.length);
            for(let i=0; i<src_image.length; i++){
                des[i] = Math.round( 0.3 * line[i] + 0.7 * hist[i] );
            }
            return des;
        }

        // ===== âœ…ã€æ ¸å¿ƒ3ï¼š1:1å¤åˆ»ä½ çš„MATLABè¿ç®—å…¬å¼ Y16=K*(X-B)ã€‘=====
        function calcKXB(){
            if(!KData || !XData || !BData) {
                alert("è¯·å…ˆå®Œæ•´åŠ è½½ Kã€X16ã€B ä¸‰ä¸ªæ–‡ä»¶ï¼");
                return;
            }
            showLoading(true);
            const pixelCount = W * H;
            calcResultData = new Uint16Array(pixelCount);
            
            // MATLABåŸç‰ˆè¿ç®—é€»è¾‘ï¼šimg_diff = X - B â†’ mul_k_x_b = (K.*img_diff)/4096 +8192
            for(let i=0; i<pixelCount; i++){
                const img_diff = XData[i] - BData[i];  // Xæ— ç¬¦å· - Bæœ‰ç¬¦å·
                let val = ( KData[i] * img_diff ) / 4096 + 8192;
                // å¯é€‰ï¼šè§£å¼€ä¸‹é¢æ³¨é‡Š åˆ‡æ¢ä¸º æ— ç¼©æ”¾ç‰ˆ Y16=K.*(X-B)
                // let val = KData[i] * img_diff;
                // è¾¹ç•Œé’³ä½ 0~65535 é˜²æ­¢æº¢å‡ºï¼Œé€‚é…Uint16æ ‡å‡†
                val = Math.max(0, Math.min(65535, val));
                calcResultData[i] = Math.round(val);
            }
            calcImgInfo();
            renderImage();
            noImg.classList.add('hidden');
            showLoading(false);
        }

        // ===== âœ…ã€æ–°å¢æ ¸å¿ƒåŠŸèƒ½ï¼šä¿å­˜è¿ç®—åçš„Y16æ•°æ®ä¸º RAW æ ¼å¼ã€‘=====
        function saveY16AsRaw(){
            if(!calcResultData) {
                alert("è¯·å…ˆæ‰§è¡Œè¿ç®—ï¼Œç”ŸæˆY16ç»“æœåå†ä¿å­˜ï¼");
                return;
            }
            showLoading(true);
            const pixelCount = W * H;
            const u8Arr = new Uint8Array(pixelCount * 2);
            
            // æŒ‰å½“å‰é€‰æ‹©çš„ã€å¤§ç«¯/å°ç«¯ã€‘æ ¼å¼å†™å…¥äºŒè¿›åˆ¶æ•°æ®ï¼Œå’Œè§£æé€»è¾‘å®Œå…¨ä¸€è‡´
            for(let i=0; i<pixelCount; i++){
                if(littleEndian){
                    // å°ç«¯ï¼šä½å­—èŠ‚åœ¨å‰ï¼Œé«˜å­—èŠ‚åœ¨å
                    u8Arr[i*2] = calcResultData[i] & 0xFF;
                    u8Arr[i*2+1] = (calcResultData[i] >> 8) & 0xFF;
                }else{
                    // å¤§ç«¯ã€é»˜è®¤ã€‘ï¼šé«˜å­—èŠ‚åœ¨å‰ï¼Œä½å­—èŠ‚åœ¨åï¼Œå…¼å®¹MATLABè¯»å–
                    u8Arr[i*2] = (calcResultData[i] >> 8) & 0xFF;
                    u8Arr[i*2+1] = calcResultData[i] & 0xFF;
                }
            }
            
            // ç”ŸæˆRAWäºŒè¿›åˆ¶æ–‡ä»¶å¹¶ä¸‹è½½
            const blob = new Blob([u8Arr], { type: 'application/octet-stream' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Y16_KXB_${W}x${H}.raw`; // æ–‡ä»¶åå¸¦åˆ†è¾¨ç‡ï¼Œæ–¹ä¾¿è¯†åˆ«
            a.click();
            URL.revokeObjectURL(a.href);
            showLoading(false);
            alert("âœ… Y16è¿ç®—ç»“æœå·²ä¿å­˜ä¸ºRAWæ ¼å¼ï¼");
        }

        // ===== å·¥å…·å‡½æ•° =====
        function getArrayMin(arr) { let min = arr[0]; for(let val of arr) if(val < min) min = val; return min; }
        function getArrayMax(arr) { let max = arr[0]; for(let val of arr) if(val > max) max = val; return max; }
        function readFileToArrayBuffer(file) {
            return new Promise((res,rej)=>{ 
                const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsArrayBuffer(file); 
            });
        }

        // ===== âœ…ã€ä¿®å¤BUGï¼šç²¾å‡†æ§åˆ¶æ–‡ä»¶åŠ è½½çŠ¶æ€ï¼Œåªæœ‰åŠ è½½æˆåŠŸæ‰æ˜¾ç¤ºã€‘=====
        async function loadFile(e, type){
            const file = e.target.files[0];
            if(!file) return;
            showLoading(true);
            // é‡ç½®å¯¹åº”æ–‡ä»¶çŠ¶æ€ä¸ºéšè—
            if(type === 'K') fileKStatus.classList.add('hidden');
            if(type === 'X') fileXStatus.classList.add('hidden');
            if(type === 'B') fileBStatus.classList.add('hidden');
            
            try {
                const buffer = await readFileToArrayBuffer(file);
                W = parseInt(wInput.value); H = parseInt(hInput.value);
                let isSuccess = false;
                if(type === 'K'){
                    fileBufferK = buffer;
                    KData = parseUint16Data(buffer);
                    isSuccess = KData !== null;
                }else if(type === 'X'){
                    fileBufferX = buffer;
                    XData = parseUint16Data(buffer);
                    isSuccess = XData !== null;
                }else if(type === 'B'){
                    fileBufferB = buffer;
                    BData = parseInt16Data(buffer);
                    isSuccess = BData !== null;
                }
                // åªæœ‰è§£ææˆåŠŸï¼Œæ‰æ˜¾ç¤ºåŠ è½½å®ŒæˆçŠ¶æ€
                if(isSuccess){
                    if(type === 'K') fileKStatus.classList.remove('hidden');
                    if(type === 'X') fileXStatus.classList.remove('hidden');
                    if(type === 'B') fileBStatus.classList.remove('hidden');
                }
            } catch (err) {
                alert('æ–‡ä»¶åŠ è½½å¤±è´¥ï¼š'+err.message);
                console.error(err);
            } finally {
                showLoading(false);
            }
        }

        // ===== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° =====
        function updateWH(){
            const nw = parseInt(wInput.value), nh = parseInt(hInput.value);
            if(nw>0 && nh>0){ 
                W=nw; H=nh;
                // é‡æ–°è§£æä¸‰ä¸ªæ–‡ä»¶
                KData = parseUint16Data(fileBufferK);
                XData = parseUint16Data(fileBufferX);
                BData = parseInt16Data(fileBufferB);
                if(calcResultData) renderImage();
            } else alert('è¯·è¾“å…¥æœ‰æ•ˆå®½é«˜');
        }
        function changeMode(mode){
            curDispMode = mode;
            curMode.textContent = mode==='origin' ? 'åŸå§‹è¿ç®—ç»“æœ' : 'æ··åˆè°ƒå…‰(0.3çº¿æ€§+0.7ç›´æ–¹å›¾)';
            renderImage();
            btnOrigin.className = mode==='origin' ? 'btn btn-primary w-full' : 'btn btn-secondary w-full';
            btnMixLight.className = mode==='mix' ? 'btn btn-primary w-full' : 'btn btn-secondary w-full';
        }
        function renderImage(){
            if(!calcResultData) return; showLoading(true);
            let disp8Data = new Uint8Array(W*H);
            if(curDispMode === 'mix'){
                disp8Data = light_mix(calcResultData);
            }else{
                const minV = getArrayMin(calcResultData);
                const maxV = getArrayMax(calcResultData);
                if(maxV === minV){
                    disp8Data.fill(0);
                }else{
                    for(let i=0; i<calcResultData.length; i++){
                        disp8Data[i] = Math.round( (calcResultData[i] - minV)*255/(maxV-minV) );
                    }
                }
            }
            const rgba = new Uint8ClampedArray(W*H*4);
            for(let y=0; y<H; y++){
                for(let x=0; x<W; x++){
                    const idx = rowMajor ? y*W+x : x*H+y;
                    const g = disp8Data[idx];
                    const rgbaIdx = (y*W+x)*4;
                    rgba[rgbaIdx] = g; rgba[rgbaIdx+1] = g; rgba[rgbaIdx+2] = g; rgba[rgbaIdx+3] = 255;
                }
            }
            canvasImgData = new ImageData(rgba, W, H);
            drawCanvas();
            showLoading(false);
        }
        function calcImgInfo(){
            const minV = getArrayMin(calcResultData);
            const maxV = getArrayMax(calcResultData);
            const avgV = Math.round(calcResultData.reduce((a,b)=>a+b)/calcResultData.length);
            imgInfo.innerHTML = `
                <p>ğŸ“Š Y16è¿ç®—ç»“æœç»Ÿè®¡ (${W}Ã—${H})</p>
                <p>è¿ç®—å…¬å¼ï¼šY16 = (K .* (X - B)) / 4096 + 8192</p>
                <p>è¿ç®—åç°åº¦èŒƒå›´ï¼š${minV} ~ ${maxV}</p>
                <p>ç°åº¦å¹³å‡å€¼ï¼š${avgV}</p>
                <p>å­˜å‚¨é…ç½®ï¼š${littleEndian?'å°ç«¯åº':'å¤§ç«¯åº'} | ${rowMajor?'è¡Œä¼˜å…ˆ':'åˆ—ä¼˜å…ˆ'}</p>
                <p class="text-gray-400 text-xs mt-1">æ··åˆè°ƒå…‰ç®—æ³•ï¼š0.3*çº¿æ€§æ‹‰ä¼¸ + 0.7*ç›´æ–¹å›¾å‡è¡¡ (MATLABåŸç‰ˆ)</p>
                <p class="text-gray-400 text-xs">ä¿å­˜æ ¼å¼ï¼šæ ‡å‡†RAW (Uint16 äºŒè¿›åˆ¶ï¼Œå…¼å®¹MATLAB)</p>
            `;
        }

        // ===== ç”»å¸ƒäº¤äº’å‡½æ•° =====
        function initCanvasEvent(){
            canvas.addEventListener('mousedown', e=>{
                isDrag=true; 
                const rect=canvas.getBoundingClientRect(); 
                lx=e.clientX-rect.left; ly=e.clientY-rect.top; 
                canvas.style.cursor='grabbing'
            });
            canvas.addEventListener('mousemove', mouseMove);
            window.addEventListener('mouseup', ()=>{isDrag=false; canvas.style.cursor='grab'});
            canvas.addEventListener('wheel', e=>{e.preventDefault(); zoomCanvas(e)});
            canvas.style.cursor = 'grab';
        }
        function mouseMove(e){
            const rect=canvas.getBoundingClientRect(); 
            const x=e.clientX-rect.left; const y=e.clientY-rect.top;
            if(isDrag){ ox += x-lx; oy += y-ly; lx=x; ly=y; drawCanvas(); }
            const ix = Math.floor((x-ox)/scale); const iy = Math.floor((y-oy)/scale);
            if(ix>=0&&ix<W&&iy>=0&&iy<H && calcResultData){
                const idx = rowMajor ? iy*W+ix : ix*H+iy;
                px.textContent = ix; py.textContent = iy; pv.textContent = calcResultData[idx];
            }else{ px.textContent='--'; py.textContent='--'; pv.textContent='--'; }
        }
        function zoomCanvas(e){
            const z = e.deltaY<0 ? 1.1 : 0.9; scale = Math.max(0.1, Math.min(10, scale*z)); drawCanvas();
        }
        function drawCanvas(){
            if(!canvasImgData) return;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.save(); ctx.translate(ox, oy); ctx.scale(scale, scale);
            ctx.imageSmoothingEnabled = false;
            ctx.putImageData(canvasImgData, 0, 0); ctx.restore();
        }
        function resizeCanvas(){
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            drawCanvas();
        }
        function showLoading(b){ loading.classList.toggle('hidden',!b); }

        // ===== åˆå§‹åŒ–+äº‹ä»¶ç»‘å®š =====
        window.addEventListener('resize', resizeCanvas);
        fileInputK.addEventListener('change', (e)=>loadFile(e,'K'));
        fileInputX.addEventListener('change', (e)=>loadFile(e,'X'));
        fileInputB.addEventListener('change', (e)=>loadFile(e,'B'));
        applySize.addEventListener('click', updateWH);
        rowMajorCb.addEventListener('change', e=>{rowMajor=e.target.checked; renderImage();});
        littleEndianCb.addEventListener('change', e=>{
            littleEndian = e.target.checked;
            KData = parseUint16Data(fileBufferK);
            XData = parseUint16Data(fileBufferX);
            BData = parseInt16Data(fileBufferB);
            if(calcResultData) calcKXB();
        });
        calcBtn.addEventListener('click', calcKXB);
        saveBtn.addEventListener('click', saveY16AsRaw); // ç»‘å®šä¿å­˜æŒ‰é’®äº‹ä»¶
        btnOrigin.addEventListener('click', ()=>{changeMode('origin')});
        btnMixLight.addEventListener('click', ()=>{changeMode('mix')});
        initCanvasEvent();
        resizeCanvas();
    </script>
</body>
</html>
